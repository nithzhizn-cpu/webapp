<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpySignal WebApp ‚Äî E2EE</title>

    <style>
        :root {
            --bg: #05070c;
            --bg-alt: #0c1018;
            --card: #121826;
            --accent: #3d7bfd;
            --accent-soft: rgba(61, 123, 253, 0.15);
            --danger: #ff4d4d;
            --text: #ffffff;
            --text-muted: #8a93a5;
            --border: #1f2433;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #182744 0, #05070c 55%);
            color: var(--text);
        }

        .app-shell {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 12px;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px 4px;
        }

        .logo-circle {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 1px solid var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 12px rgba(0, 255, 180, 0.35);
            background: radial-gradient(circle at 30% 20%, #26ffe0 0, #060811 55%);
        }

        .logo-circle span {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .header-text h1 {
            font-size: 18px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tagline {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .pill {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid rgba(61, 123, 253, 0.4);
            background: rgba(8, 15, 32, 0.9);
            text-transform: uppercase;
            letter-spacing: .06em;
        }

        .status-bar {
            margin: 6px 4px 8px;
            padding: 7px 10px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            font-size: 11px;
            background: rgba(3, 10, 25, 0.9);
            border: 1px solid var(--border);
            justify-content: space-between;
            gap: 8px;
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(77, 255, 153, 0.8);
            background: radial-gradient(circle, #81ffb7 0, #08c96a 60%);
        }

        .status-dot.offline {
            background: radial-gradient(circle, #ff9b9b 0, #ff4040 60%);
            box-shadow: 0 0 8px rgba(255, 64, 64, 0.8);
        }

        .status-label { font-weight: 500; }

        .status-url {
            font-size: 10px;
            color: var(--text-muted);
        }

        .sec-indicator {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid rgba(140, 255, 195, 0.8);
            background: rgba(9, 24, 20, 0.9);
            color: #9dffd0;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .card {
            background: rgba(11, 15, 27, 0.96);
            border-radius: 16px;
            padding: 14px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.7);
            margin-bottom: 10px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .card-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .field-label {
            font-size: 11px;
            color: var(--text-muted);
            margin: 6px 2px 2px;
        }

        .input {
            width: 100%;
            padding: 9px 11px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #060a13;
            color: var(--text);
            font-size: 14px;
            outline: none;
        }

        .input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(61, 123, 253, 0.6);
        }

        .btn {
            width: 100%;
            padding: 10px 14px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            background: linear-gradient(135deg, #3d7bfd, #47d3ff);
            color: #fff;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:active {
            transform: translateY(1px);
            filter: brightness(.95);
        }

        .btn-secondary {
            background: rgba(7, 12, 26, 0.9);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-small {
            width: auto;
            padding: 6px 10px;
            font-size: 11px;
            border-radius: 999px;
        }

        .hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .chat-window {
            border-radius: 12px;
            border: 1px solid var(--border);
            background: radial-gradient(circle at top left, rgba(61, 123, 253, .08) 0, #05070c 40%);
            height: 270px;
            padding: 8px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .msg {
            padding: 7px 10px;
            border-radius: 11px;
            font-size: 13px;
            max-width: 78%;
            line-height: 1.4;
            background: #171f32;
            animation: fadeUp .18s ease-out forwards;
            opacity: 0;
            transform: translateY(4px);
        }

        .msg.me {
            margin-left: auto;
            background: linear-gradient(135deg, #3d7bfd, #40c3ff);
        }

        .msg-meta {
            font-size: 9px;
            color: #b8c2d8;
            margin-top: 2px;
        }

        .msg-file {
            font-size: 12px;
            word-break: break-all;
        }

        .msg-file a {
            color: #9ce0ff;
            text-decoration: none;
        }

        .msg-file a:hover {
            text-decoration: underline;
        }

        @keyframes fadeUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-input-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
        }

        .chat-input {
            flex: 1;
        }

        .chat-send-btn {
            width: 44px;
            height: 38px;
            border-radius: 12px;
            background: var(--accent);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .chat-send-btn span { font-size: 18px; }

        .file-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 6px;
        }

        .file-row input[type="file"] {
            font-size: 11px;
            color: var(--text-muted);
        }

        .footer-hint {
            margin-top: 6px;
            text-align: center;
            font-size: 10px;
            color: var(--text-muted);
        }

        .footer-hint strong { color: #61ffa8; }

        .toast {
            position: fixed;
            bottom: 14px;
            left: 50%;
            transform: translateX(-50%);
            background: #141a28;
            border-radius: 999px;
            border: 1px solid var(--border);
            padding: 7px 14px;
            font-size: 12px;
            display: none;
            align-items: center;
            gap: 6px;
            z-index: 999;
        }

        .toast.show {
            display: inline-flex;
            animation: fadeToast .25s ease-out;
        }

        .toast-error {
            border-color: rgba(255, 85, 85, 0.6);
            color: #ffb3b3;
        }

        @keyframes fadeToast {
            from {
                opacity: 0;
                transform: translate(-50%, 4px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }
    </style>
</head>
<body>
<div class="app-shell">
    <header class="header">
        <div class="logo-circle">
            <span>SS</span>
        </div>
        <div class="header-text">
            <h1>SpySignal <span class="pill">E2EE</span></h1>
            <div class="tagline">–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π —á–∞—Ç & —Ñ–∞–π–ª–∏ (WebApp)</div>
        </div>
    </header>

    <div class="status-bar">
        <div class="status-left">
            <div id="status-dot" class="status-dot"></div>
            <div>
                <div class="status-label" id="status-label">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞‚Ä¶</div>
                <div class="status-url" id="status-url"></div>
            </div>
        </div>
        <div class="sec-indicator" id="sec-indicator">
            üîê –†—ñ–≤–µ–Ω—å: –±–∞–∑–æ–≤–∏–π
        </div>
    </div>

    <!-- 1. –õ–æ–≥—ñ–Ω / —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è -->
    <section class="card" id="login-card">
        <div class="card-title">
            <span>1 ¬∑ –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∞–≥–µ–Ω—Ç–∞</span>
        </div>
        <div class="card-subtitle">
            –í–≤–µ–¥–∏ —Å–≤—ñ–π –ø–æ–∑–∏–≤–Ω–∏–π. –ü—ñ—Å–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –æ—Ç—Ä–∏–º–∞—î—à <strong>ID –∞–≥–µ–Ω—Ç–∞</strong>, –π–æ–≥–æ —Ç—Ä–µ–±–∞ –¥–∞—Ç–∏ —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫—É.
        </div>

        <div class="field-label">–ü–æ–∑–∏–≤–Ω–∏–π (username)</div>
        <input id="username" class="input" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, ShadowFox" autocomplete="off">

        <button class="btn" onclick="registerUser()">
            üîì –£–≤—ñ–π—Ç–∏ –≤ SpySignal
        </button>

        <div class="hint" id="my-id-hint" style="display:none;"></div>
    </section>

    <!-- 2. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥—ñ–∞–ª–æ–≥—É + —á–∞—Ç -->
    <section class="card" id="chat-card" style="display:none;">
        <div class="card-title">
            <span>2 ¬∑ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥—ñ–∞–ª–æ–≥—É</span>
            <button class="btn-small btn-secondary" onclick="resetDialogKey()">
                üîÅ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∫–ª—é—á—ñ
            </button>
        </div>

        <div class="card-subtitle">
            –û–±–∏–¥–≤–∞ –∞–≥–µ–Ω—Ç–∏ –ø–æ–≤–∏–Ω–Ω—ñ:
            <br>‚Ä¢ –º–∞—Ç–∏ <strong>ID –æ–¥–∏–Ω –æ–¥–Ω–æ–≥–æ</strong>;
            <br>‚Ä¢ –¥–æ–º–æ–≤–∏—Ç–∏—Å—å –ø—Ä–æ <strong>–ü–∞—Ä–æ–ª—å –¥—ñ–∞–ª–æ–≥—É</strong> (—Ç—ñ–ª—å–∫–∏ –º—ñ–∂ –≤–∞–º–∏).
        </div>

        <div class="field-label">ID —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞ (peer ID)</div>
        <input id="peer-id" class="input" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, 2" oninput="onPeerChange()">

        <div class="field-label">–ü–∞—Ä–æ–ª—å –¥—ñ–∞–ª–æ–≥—É (—Å–ø—ñ–ª—å–Ω–∏–π —Å–µ–∫—Ä–µ—Ç)</div>
        <input id="dialog-secret" class="input" placeholder="–ü–∞—Ä–æ–ª—å, –ø—Ä–æ —è–∫–∏–π –≤–∏ –¥–æ–º–æ–≤–∏–ª–∏—Å—å">

        <div class="hint">
            üîê –ù–∞ –æ—Å–Ω–æ–≤—ñ –ø–∞—Ä–æ–ª—è –¥—ñ–∞–ª–æ–≥—É –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∫–æ—Ä–µ–Ω–µ–≤–∏–π –∫–ª—é—á. –ë–µ–∑ –Ω—å–æ–≥–æ –Ω—ñ—Ö—Ç–æ –Ω–µ —Ä–æ–∑—à–∏—Ñ—Ä—É—î —ñ—Å—Ç–æ—Ä—ñ—é, –Ω–∞–≤—ñ—Ç—å —Å–µ—Ä–≤–µ—Ä.
        </div>
    </section>

    <section class="card" id="messages-card" style="display:none;">
        <div class="card-title">
            <span>3 ¬∑ –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π —á–∞—Ç & —Ñ–∞–π–ª–∏</span>
        </div>

        <div class="chat-window" id="chat"></div>

        <div class="file-row">
            <input type="file" id="file-input">
            <button class="btn-small btn-secondary" onclick="sendFile()">
                üìé –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ñ–∞–π–ª (E2EE)
            </button>
        </div>

        <div class="chat-input-row">
            <div class="chat-input">
                <input id="msg" class="input" placeholder="–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è‚Ä¶">
            </div>
            <button class="chat-send-btn" onclick="sendMessage()">
                <span>‚û§</span>
            </button>
        </div>

        <div class="footer-hint">
            –í—Å—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Ç–∞ —Ñ–∞–π–ª–∏ —à–∏—Ñ—Ä—É—é—Ç—å—Å—è <strong>–Ω–∞ —Ç–≤–æ—î–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó</strong>. –°–µ—Ä–≤–µ—Ä –∑–±–µ—Ä—ñ–≥–∞—î –ª–∏—à–µ ciphertext.
        </div>
    </section>

    <div class="toast" id="toast"></div>
</div>

<script>
    // ================== –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ==================
    const API_BASE = "https://talented-energy-production.up.railway.app"; // üëà –ó–ê–ú–Ü–ù–ò –Ω–∞ —Å–≤—ñ–π –¥–æ–º–µ–Ω Railway

    const encoder = new TextEncoder();
    const decoder = new TextDecoder();

    const statusDot = document.getElementById("status-dot");
    const statusLabel = document.getElementById("status-label");
    const statusUrl = document.getElementById("status-url");
    const secIndicator = document.getElementById("sec-indicator");
    const toastEl = document.getElementById("toast");
    const chatEl = document.getElementById("chat");

    statusUrl.textContent = API_BASE.replace("https://", "");

    let myID = null;
    let myUsername = null;
    let pollingTimer = null;

    // –°—Ç–∞–Ω –¥—ñ–∞–ª–æ–≥—ñ–≤ —É –ø–∞–º'—è—Ç—ñ + localStorage
    const DIALOG_STATE_KEY = "spysignal_dialogs_v1";
    let dialogState = loadDialogState(); // { peerId: { rootKeyB64: "..."} }

    function loadDialogState() {
        try {
            const raw = localStorage.getItem(DIALOG_STATE_KEY);
            if (!raw) return {};
            return JSON.parse(raw);
        } catch (e) {
            console.warn("–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è dialogState:", e);
            return {};
        }
    }

    function saveDialogState() {
        try {
            localStorage.setItem(DIALOG_STATE_KEY, JSON.stringify(dialogState));
        } catch (e) {
            console.warn("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è dialogState:", e);
        }
    }

    function showToast(msg, isError = false) {
        toastEl.textContent = msg;
        toastEl.className = "toast show" + (isError ? " toast-error" : "");
        setTimeout(() => {
            toastEl.classList.remove("show");
        }, 2500);
    }

    function bufToBase64(buf) {
        let bin = "";
        const bytes = new Uint8Array(buf);
        for (let b of bytes) bin += String.fromCharCode(b);
        return btoa(bin);
    }

    function base64ToBuf(b64) {
        const bin = atob(b64);
        const bytes = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) {
            bytes[i] = bin.charCodeAt(i);
        }
        return bytes.buffer;
    }

    // ================== –ü–ï–†–ï–í–Ü–†–ö–ê –°–ï–†–í–ï–†–ê ==================
    async function checkHealth() {
        try {
            const res = await fetch(`${API_BASE}/health`);
            if (!res.ok) throw new Error("bad status");
            const data = await res.json();
            if (data.status === "ok") {
                statusDot.classList.remove("offline");
                statusLabel.textContent = "–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ —Å–µ—Ä–≤–µ—Ä–∞";
            } else {
                statusDot.classList.add("offline");
                statusLabel.textContent = "–°–µ—Ä–≤–µ—Ä –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–æ";
            }
        } catch (e) {
            statusDot.classList.add("offline");
            statusLabel.textContent = "–ù–µ–º–∞—î –∑–≤'—è–∑–∫—É –∑ –±–µ–∫–µ–Ω–¥–æ–º";
        }
    }
    checkHealth();
    setInterval(checkHealth, 8000);

    // ================== –ö–õ–Æ–ß–Ü –î–Ü–ê–õ–û–ì–£ (PBKDF2 + HKDF) ==================

    async function deriveRootKeyBytes(passphrase, myId, peerId) {
        const a = Math.min(myId, peerId);
        const b = Math.max(myId, peerId);
        const baseStr = `${passphrase}|${a}|${b}`;
        const baseKey = await crypto.subtle.importKey(
            "raw",
            encoder.encode(baseStr),
            "PBKDF2",
            false,
            ["deriveBits"]
        );
        const salt = encoder.encode("SpySignal-Dialog-Root");
        const bits = await crypto.subtle.deriveBits(
            {
                name: "PBKDF2",
                salt,
                iterations: 100000,
                hash: "SHA-256"
            },
            baseKey,
            256
        );
        return new Uint8Array(bits); // 32 –±–∞–π—Ç–∏
    }

    async function getRootKeyBytesForPeer(peerId) {
        const secret = document.getElementById("dialog-secret").value.trim();
        if (!secret) {
            showToast("–°–ø–æ—á–∞—Ç–∫—É –≤–≤–µ–¥–∏ –ü–∞—Ä–æ–ª—å –¥—ñ–∞–ª–æ–≥—É", true);
            throw new Error("No dialog secret");
        }
        if (!myID) {
            showToast("–°–ø–æ—á–∞—Ç–∫—É –≤–∏–∫–æ–Ω–∞–π —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é", true);
            throw new Error("No myID");
        }

        const key = String(peerId);
        if (dialogState[key] && dialogState[key].rootKeyB64) {
            return new Uint8Array(base64ToBuf(dialogState[key].rootKeyB64));
        }

        const rootBytes = await deriveRootKeyBytes(secret, myID, peerId);
        dialogState[key] = { rootKeyB64: bufToBase64(rootBytes.buffer) };
        saveDialogState();
        updateSecurityIndicator();
        return rootBytes;
    }

    async function deriveMsgKey(rootKeyBytes, saltBytes) {
        const hkdfKey = await crypto.subtle.importKey(
            "raw",
            rootKeyBytes,
            "HKDF",
            false,
            ["deriveBits"]
        );
        const bits = await crypto.subtle.deriveBits(
            {
                name: "HKDF",
                hash: "SHA-256",
                salt: saltBytes,
                info: encoder.encode("SpySignal-Message-Key")
            },
            hkdfKey,
            256
        );
        return crypto.subtle.importKey(
            "raw",
            new Uint8Array(bits),
            { name: "AES-GCM" },
            false,
            ["encrypt", "decrypt"]
        );
    }

    async function encryptForDialog(peerId, payloadObj) {
        const rootBytes = await getRootKeyBytesForPeer(peerId);
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const msgKey = await deriveMsgKey(rootBytes, salt);
        const plaintext = encoder.encode(JSON.stringify(payloadObj));
        const ctBuf = await crypto.subtle.encrypt(
            { name: "AES-GCM", iv },
            msgKey,
            plaintext
        );

        const envelope = {
            v: 1,
            s: bufToBase64(salt.buffer),
            iv: bufToBase64(iv.buffer),
            ct: bufToBase64(ctBuf),
            t: payloadObj.type || "text"
        };
        const ciphertextField = btoa(JSON.stringify(envelope));
        return { ciphertextField, ivField: envelope.iv };
    }

    async function decryptForDialog(peerId, ciphertextField) {
        const jsonStr = atob(ciphertextField);
        let envelope;
        try {
            envelope = JSON.parse(jsonStr);
        } catch (e) {
            console.warn("Envelope parse error:", e);
            throw new Error("Bad envelope");
        }
        if (!envelope.s || !envelope.iv || !envelope.ct) {
            throw new Error("Invalid envelope");
        }
        const rootBytes = await getRootKeyBytesForPeer(peerId);
        const salt = new Uint8Array(base64ToBuf(envelope.s));
        const iv = new Uint8Array(base64ToBuf(envelope.iv));
        const ctBuf = base64ToBuf(envelope.ct);

        const msgKey = await deriveMsgKey(rootBytes, salt);
        const plainBuf = await crypto.subtle.decrypt(
            { name: "AES-GCM", iv },
            msgKey,
            ctBuf
        );
        const text = decoder.decode(plainBuf);
        const payload = JSON.parse(text);
        return payload;
    }

    function updateSecurityIndicator() {
        const peerIdStr = document.getElementById("peer-id").value.trim();
        if (!peerIdStr || !myID) {
            secIndicator.textContent = "üîê –†—ñ–≤–µ–Ω—å: –±–∞–∑–æ–≤–∏–π";
            return;
        }
        const key = String(parseInt(peerIdStr, 10));
        if (dialogState[key] && dialogState[key].rootKeyB64) {
            secIndicator.textContent = "üõ°Ô∏è –†—ñ–≤–µ–Ω—å: –≤–∏—Å–æ–∫–∏–π (–ª–æ–∫–∞–ª—å–Ω–µ E2EE)";
        } else {
            secIndicator.textContent = "üîê –†—ñ–≤–µ–Ω—å: –±–∞–∑–æ–≤–∏–π";
        }
    }

    function resetDialogKey() {
        const peerIdStr = document.getElementById("peer-id").value.trim();
        if (!peerIdStr) {
            showToast("–°–ø–æ—á–∞—Ç–∫—É –≤–≤–µ–¥–∏ ID —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞", true);
            return;
        }
        const key = String(parseInt(peerIdStr, 10));
        delete dialogState[key];
        saveDialogState();
        updateSecurityIndicator();
        showToast("–ö–ª—é—á—ñ –¥—ñ–∞–ª–æ–≥—É –æ—á–∏—â–µ–Ω–æ. –í–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å –¥—ñ–∞–ª–æ–≥—É —â–µ —Ä–∞–∑.");
    }

    function onPeerChange() {
        updateSecurityIndicator();
        // –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
        if (pollingTimer) clearInterval(pollingTimer);
        startPolling();
    }

    // ================== –†–ï–Ñ–°–¢–†–ê–¶–Ü–Ø –ö–û–†–ò–°–¢–£–í–ê–ß–ê ==================
    async function registerUser() {
        const username = document.getElementById("username").value.trim();
        if (!username) {
            showToast("–í–≤–µ–¥–∏ –ø–æ–∑–∏–≤–Ω–∏–π (username)", true);
            return;
        }
        try {
            const res = await fetch(`${API_BASE}/api/users/register`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username })
            });
            const data = await res.json();
            if (!res.ok || !data.id) {
                console.error("Register error:", data);
                showToast("–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó", true);
                return;
            }

            myID = data.id;
            myUsername = data.username;

            document.getElementById("login-card").style.display = "none";
            document.getElementById("chat-card").style.display = "block";
            document.getElementById("messages-card").style.display = "block";

            const hint = document.getElementById("my-id-hint");
            hint.style.display = "block";
            hint.textContent = `–¢–≤—ñ–π ID –∞–≥–µ–Ω—Ç–∞: ${myID}. –ü–µ—Ä–µ–¥–∞–π –π–æ–≥–æ —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫—É.`;

            showToast("–£—Å–ø—ñ—à–Ω–æ. –¢–≤—ñ–π ID: " + myID);
            updateSecurityIndicator();
            startPolling();
        } catch (e) {
            console.error(e);
            showToast("–ù–µ –≤–¥–∞–ª–æ—Å—å –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—å –¥–æ —Å–µ—Ä–≤–µ—Ä–∞", true);
        }
    }

    // ================== –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø ==================
    async function sendMessage() {
        if (!myID) {
            showToast("–°–ø–æ—á–∞—Ç–∫—É –∑–∞—Ä–µ—î—Å—Ç—Ä—É–π—Å—è", true);
            return;
        }
        const peerStr = document.getElementById("peer-id").value.trim();
        if (!peerStr) {
            showToast("–í–≤–µ–¥–∏ ID —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞", true);
            return;
        }
        const peerId = parseInt(peerStr, 10);
        if (!peerId || peerId <= 0) {
            showToast("–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π peer ID", true);
            return;
        }
        const msgInput = document.getElementById("msg");
        const text = msgInput.value.trim();
        if (!text) return;

        try {
            const payload = {
                type: "text",
                text
            };
            const { ciphertextField, ivField } = await encryptForDialog(peerId, payload);

            await fetch(`${API_BASE}/api/messages`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    to: peerId,
                    iv: ivField,
                    ciphertext: ciphertextField
                })
            });

            msgInput.value = "";
            await loadMessagesOnce(); // –æ–Ω–æ–≤–∏—Ç–∏ —á–∞—Ç
        } catch (e) {
            console.error("Send message error:", e);
            showToast("–ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è", true);
        }
    }

    async function sendFile() {
        if (!myID) {
            showToast("–°–ø–æ—á–∞—Ç–∫—É –∑–∞—Ä–µ—î—Å—Ç—Ä—É–π—Å—è", true);
            return;
        }
        const peerStr = document.getElementById("peer-id").value.trim();
        if (!peerStr) {
            showToast("–í–≤–µ–¥–∏ ID —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞", true);
            return;
        }
        const peerId = parseInt(peerStr, 10);
        if (!peerId || peerId <= 0) {
            showToast("–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π peer ID", true);
            return;
        }
        const fileInput = document.getElementById("file-input");
        const file = fileInput.files[0];
        if (!file) {
            showToast("–§–∞–π–ª –Ω–µ –æ–±—Ä–∞–Ω–æ", true);
            return;
        }
        try {
            const buf = await file.arrayBuffer();
            const b64data = bufToBase64(buf);

            const payload = {
                type: "file",
                name: file.name,
                size: file.size,
                mime: file.type || "application/octet-stream",
                data: b64data
            };

            const { ciphertextField, ivField } = await encryptForDialog(peerId, payload);

            await fetch(`${API_BASE}/api/messages`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    to: peerId,
                    iv: ivField,
                    ciphertext: ciphertextField
                })
            });

            fileInput.value = "";
            showToast("–§–∞–π–ª –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ (E2EE)");
            await loadMessagesOnce();
        } catch (e) {
            console.error("Send file error:", e);
            showToast("–ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ñ–∞–π–ª", true);
        }
    }

    async function loadMessagesOnce() {
        if (!myID) return;
        const peerStr = document.getElementById("peer-id").value.trim();
        if (!peerStr) return;
        const peerId = parseInt(peerStr, 10);
        if (!peerId || peerId <= 0) return;

        try {
            const res = await fetch(`${API_BASE}/api/messages?peer_id=${peerId}`);
            const data = await res.json();
            const msgs = data.messages || [];

            chatEl.innerHTML = "";

            for (const m of msgs) {
                let fromMe = (m.from_id === myID);
                let payload;
                try {
                    payload = await decryptForDialog(peerId, m.ciphertext);
                } catch (e) {
                    console.warn("Decrypt error for message:", e);
                    addMessageBubble("[–Ω–µ –≤–¥–∞–ª–æ—Å—è —Ä–æ–∑—à–∏—Ñ—Ä—É–≤–∞—Ç–∏]", fromMe, m.created_at);
                    continue;
                }

                if (payload.type === "file") {
                    const url = `data:${payload.mime};base64,${payload.data}`;
                    const textHtml = `
                        <div class="msg-file">
                            üìé –§–∞–π–ª: <a href="${url}" download="${payload.name}">${payload.name}</a><br>
                            <span style="font-size:10px;color:#8a93a5;">${Math.round(payload.size/1024)} KB</span>
                        </div>
                    `;
                    addMessageBubble(textHtml, fromMe, m.created_at, true);
                } else {
                    addMessageBubble(payload.text || "", fromMe, m.created_at);
                }
            }

            chatEl.scrollTop = chatEl.scrollHeight;
        } catch (e) {
            console.error("Load messages error:", e);
        }
    }

    function addMessageBubble(htmlOrText, fromMe, createdAt, isHtml = false) {
        const div = document.createElement("div");
        div.className = "msg" + (fromMe ? " me" : "");
        if (isHtml) {
            div.innerHTML = htmlOrText;
        } else {
            div.textContent = htmlOrText;
        }
        const meta = document.createElement("div");
        meta.className = "msg-meta";
        let timeStr = "";
        if (createdAt) {
            const d = new Date(createdAt);
            const hh = String(d.getHours()).padStart(2, "0");
            const mm = String(d.getMinutes()).padStart(2, "0");
            timeStr = `${hh}:${mm}`;
        }
        meta.textContent = timeStr;
        div.appendChild(meta);
        chatEl.appendChild(div);
    }

    function startPolling() {
        if (pollingTimer) clearInterval(pollingTimer);
        pollingTimer = setInterval(loadMessagesOnce, 2500);
        loadMessagesOnce();
    }

    // Telegram WebApp –∞–≤—Ç–æ–∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è username (—è–∫—â–æ —î)
    (function tryTelegramInit() {
        try {
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.expand();
                const u = tg.initDataUnsafe && tg.initDataUnsafe.user;
                if (u && u.username) {
                    document.getElementById("username").value = u.username;
                }
            }
        } catch (e) {
            console.warn("Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π –∞–±–æ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è", e);
        }
    })();
</script>
</body>
</html>