<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>SpySignal ‚Äî Secure & Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        :root {
            --bg: #05070c;
            --bg-alt: #0c1018;
            --card: #121826;
            --accent: #3d7bfd;
            --accent-soft: rgba(61, 123, 253, 0.15);
            --danger: #ff4d4d;
            --text: #ffffff;
            --text-muted: #8a93a5;
            --border: #1f2433;
            --gold: #ffdd55;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #182744 0, #05070c 55%);
            color: var(--text);
        }

        .app-shell {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 12px;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px 4px;
        }

        .logo-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 12px rgba(0, 255, 180, 0.35);
            background: radial-gradient(circle at 30% 20%, #26ffe0 0, #060811 55%);
        }

        .logo-circle span {
            font-size: 19px;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .header-text h1 {
            font-size: 18px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tagline {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .pill {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid rgba(61, 123, 253, 0.4);
            background: rgba(8, 15, 32, 0.9);
            text-transform: uppercase;
            letter-spacing: .06em;
        }

        .pill-pro {
            border-color: rgba(255, 221, 85, 0.8);
            color: var(--gold);
            background: rgba(64, 48, 5, 0.9);
        }

        .status-bar {
            margin: 6px 4px 8px;
            padding: 7px 10px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            font-size: 11px;
            background: rgba(3, 10, 25, 0.9);
            border: 1px solid var(--border);
            justify-content: space-between;
            gap: 6px;
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(77, 255, 153, 0.8);
            background: radial-gradient(circle, #81ffb7 0, #08c96a 60%);
        }

        .status-dot.offline {
            background: radial-gradient(circle, #ff9b9b 0, #ff4040 60%);
            box-shadow: 0 0 8px rgba(255, 64, 64, 0.8);
        }

        .status-label {
            font-weight: 500;
        }

        .status-url {
            color: var(--text-muted);
            opacity: .8;
        }

        .security-indicator {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid rgba(97, 255, 168, 0.7);
            background: rgba(6, 20, 18, 0.9);
            color: #9dffd0;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .card {
            background: rgba(11, 15, 27, 0.96);
            border-radius: 16px;
            padding: 14px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.7);
            margin-bottom: 10px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
        }

        .card-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .field-label {
            font-size: 11px;
            color: var(--text-muted);
            margin: 6px 2px 2px;
        }

        .input {
            width: 100%;
            padding: 9px 11px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #060a13;
            color: var(--text);
            font-size: 14px;
            outline: none;
        }

        .input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(61, 123, 253, 0.6);
        }

        .btn {
            width: 100%;
            padding: 10px 14px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            background: linear-gradient(135deg, #3d7bfd, #47d3ff);
            color: #fff;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:active {
            transform: translateY(1px);
            filter: brightness(.95);
        }

        .btn-secondary {
            background: rgba(7, 12, 26, 0.9);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-pro {
            background: linear-gradient(135deg, #ffdd55, #ff9e2c);
            color: #1b1302;
        }

        .btn-small {
            width: auto;
            padding: 6px 10px;
            font-size: 11px;
            border-radius: 999px;
        }

        .pill-plan {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid rgba(255, 221, 85, 0.7);
            color: var(--gold);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .two-blocks {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .badge-e2ee {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid rgba(140, 255, 195, 0.8);
            background: rgba(9, 24, 20, 0.9);
            color: #9dffd0;
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }

        .badge-free {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid rgba(113, 125, 150, 0.8);
            color: #c0c4cf;
            background: rgba(10, 12, 18, 0.9);
        }

        .search-results {
            max-height: 160px;
            overflow-y: auto;
            margin-top: 6px;
        }

        .user-item {
            background: #0c1018;
            border-radius: 10px;
            padding: 8px 9px;
            margin-bottom: 6px;
            border: 1px solid rgba(54, 63, 90, 0.8);
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .user-item:hover {
            border-color: var(--accent);
            background: rgba(14, 20, 37, 0.95);
        }

        .user-name {
            font-size: 13px;
            font-weight: 500;
        }

        .user-id {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 1px;
        }

        .chat-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 4px;
        }

        .chat-peer {
            font-size: 13px;
            font-weight: 500;
        }

        .chat-peer span {
            color: var(--accent);
        }

        .chat-window {
            border-radius: 12px;
            border: 1px solid var(--border);
            background: radial-gradient(circle at top left, rgba(61, 123, 253, .08) 0, #05070c 40%);
            height: 260px;
            padding: 8px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .msg {
            padding: 7px 10px;
            border-radius: 11px;
            font-size: 13px;
            max-width: 78%;
            line-height: 1.4;
            background: #171f32;
            animation: fadeUp .18s ease-out forwards;
            opacity: 0;
            transform: translateY(4px);
        }

        .msg.me {
            margin-left: auto;
            background: linear-gradient(135deg, #3d7bfd, #40c3ff);
        }

        .msg-meta {
            font-size: 9px;
            color: #b8c2d8;
            margin-top: 2px;
        }

        @keyframes fadeUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-input-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
        }

        .chat-input {
            flex: 1;
        }

        .chat-send-btn {
            width: 44px;
            height: 38px;
            border-radius: 12px;
            background: var(--accent);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .chat-send-btn span { font-size: 18px; }

        .file-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 6px;
        }

        .file-row input[type="file"] {
            flex: 1;
            font-size: 11px;
            color: var(--text-muted);
        }

        .pill-pro-only {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px dashed rgba(255, 221, 85, 0.8);
            color: var(--gold);
        }

        .toast {
            position: fixed;
            bottom: 14px;
            left: 50%;
            transform: translateX(-50%);
            background: #141a28;
            border-radius: 999px;
            border: 1px solid var(--border);
            padding: 7px 14px;
            font-size: 12px;
            display: none;
            align-items: center;
            gap: 6px;
            z-index: 999;
        }

        .toast.show {
            display: inline-flex;
            animation: fadeToast .25s ease-out;
        }

        .toast-error {
            border-color: rgba(255, 85, 85, 0.6);
            color: #ffb3b3;
        }

        @keyframes fadeToast {
            from { opacity: 0; transform: translate(-50%, 4px); }
            to   { opacity: 1; transform: translate(-50%, 0); }
        }

        .premium-list {
            margin-top: 6px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .premium-list li {
            margin-bottom: 3px;
        }

        .lock-icon {
            font-size: 12px;
        }
    </style>
</head>
<body>
<div class="app-shell">
    <header class="header">
        <div class="logo-circle"><span>SS</span></div>
        <div class="header-text">
            <h1>
                SpySignal
                <span class="pill">E2EE</span>
                <span id="plan-pill" class="pill pill-pro" style="display:none;">PRO</span>
                <span id="plan-pill-free" class="pill badge-free">Free</span>
            </h1>
            <div class="tagline">–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π –º–µ—Å–µ–Ω–¥–∂–µ—Ä –∑ Premium-—Ä—ñ–≤–Ω–µ–º –∑–∞—Ö–∏—Å—Ç—É</div>
        </div>
    </header>

    <div class="status-bar">
        <div class="status-left">
            <div id="status-dot" class="status-dot"></div>
            <div>
                <div class="status-label" id="status-label">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞‚Ä¶</div>
                <div class="status-url" id="status-url"></div>
            </div>
        </div>
        <div class="security-indicator" id="security-indicator">
            üîê Forward-secure —á–∞—Ç
        </div>
    </div>

    <!-- Premium / Upgrade –±–ª–æ–∫ -->
    <section class="card" id="premium-card" style="display:none;">
        <div class="card-title">
            <span>SpySignal PRO</span>
            <span class="pill-plan">4.99$/–º—ñ—Å ‚Ä¢ Max privacy</span>
        </div>
        <div class="card-subtitle">
            –û—Ç—Ä–∏–º–∞–π –ø–æ–≤–Ω–∏–π –Ω–∞–±—ñ—Ä —Ñ—É–Ω–∫—Ü—ñ–π: —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤, –∞–Ω–æ–Ω—ñ–º–Ω—ñ –¥–∑–≤—ñ–Ω–∫–∏, stealth-—Ä–µ–∂–∏–º, —Ç–∞–π–º–µ—Ä —Å–∞–º–æ–∑–Ω–∏—â–µ–Ω–Ω—è.
        </div>
        <ul class="premium-list">
            <li>üóù –û–∫—Ä–µ–º—ñ –∫–ª—é—á—ñ –Ω–∞ –∫–æ–∂–µ–Ω –¥—ñ–∞–ª–æ–≥ + forward secrecy</li>
            <li>üìÅ –®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ –¥–æ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ (AES-256)</li>
            <li>üìû E2EE-–¥–∑–≤—ñ–Ω–∫–∏ —á–µ—Ä–µ–∑ WebRTC</li>
            <li>‚è≥ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ —Ç–∞–π–º–µ—Ä–æ–º —Å–∞–º–æ–∑–Ω–∏—â–µ–Ω–Ω—è</li>
            <li>ü´• Stealth —Ä–µ–∂–∏–º —Ç–∞ –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ –∫–æ–Ω—Ç–∞–∫—Ç–∏</li>
        </ul>
        <button class="btn btn-pro" onclick="fakeUpgradePro()">
            ‚≠ê Upgrade to SpySignal PRO (demo)
        </button>
        <div class="hint">–ó–∞—Ä–∞–∑ ‚Äî –¥–µ–º–æ-—Ä–µ–∂–∏–º: –∞–ø–≥—Ä–µ–π–¥ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ—ó –æ–ø–ª–∞—Ç–∏ (–¥–ª—è —Ç–µ—Å—Ç—ñ–≤).</div>
    </section>

    <!-- –õ–æ–≥—ñ–Ω -->
    <section class="card" id="login-card">
        <div class="card-title">
            <span>1 ¬∑ –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∞–≥–µ–Ω—Ç–∞</span>
            <span class="badge-e2ee">–ö–ª—é—á—ñ –≥–µ–Ω–µ—Ä—É—é—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ</span>
        </div>
        <div class="card-subtitle">
            –í–≤–µ–¥–∏ –ø–æ–∑–∏–≤–Ω–∏–π. –ê–∫–∫–∞—É–Ω—Ç –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Å—Ç–∞–Ω—É Pro/Free, –∫–ª—é—á—ñ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —É —Ç–≤–æ—î–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó.
        </div>

        <div class="field-label">–ü–æ–∑–∏–≤–Ω–∏–π (username)</div>
        <input id="username" class="input" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, ShadowFox" autocomplete="off">

        <button class="btn" onclick="registerUser()">
            üîì –£–≤—ñ–π—Ç–∏ –≤ SpySignal
        </button>

        <div class="hint" id="my-id-hint" style="display:none;"></div>
    </section>

    <!-- –û—Å–Ω–æ–≤–Ω–∞ –∑–æ–Ω–∞: –ø–æ—à—É–∫ + —á–∞—Ç + —Ñ–∞–π–ª–∏ -->
    <section class="two-blocks" id="main-blocks" style="display:none;">
        <div class="card">
            <div class="card-title">
                <span>2 ¬∑ –ü–æ—à—É–∫ –∫–æ–Ω—Ç–∞–∫—Ç—É</span>
                <button class="btn-small btn-secondary" onclick="backToLogin()">–ó–º—ñ–Ω–∏—Ç–∏ –∞–≥–µ–Ω—Ç–∞</button>
            </div>
            <div class="card-subtitle">
                –ó–Ω–∞–π–¥–∏ —ñ–Ω—à–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –ø–æ ID –∞–±–æ –Ω—ñ–∫–Ω–µ–π–º—É, –≤—Å—Ç–∞–Ω–æ–≤–∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π –∫–∞–Ω–∞–ª.
            </div>

            <div class="field-label">–ü–æ—à—É–∫ (ID –∞–±–æ username)</div>
            <input id="search" class="input" placeholder="–ü—Ä–∏–∫–ª–∞–¥: 2 –∞–±–æ NightOwl" oninput="searchUser()">

            <div class="search-results" id="result"></div>
        </div>

        <div class="card" id="chat-card" style="opacity:0.5; pointer-events:none;">
            <div class="chat-header-row">
                <div class="chat-peer" id="chat-peer">
                    3 ¬∑ –ß–∞—Ç <span>(–æ–±–µ—Ä–∏ —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞)</span>
                </div>
                <div>
                    <span class="pill-pro-only" id="pro-only-label" style="display:none;">
                        PRO: —Ñ–∞–π–ª–∏, –¥–∑–≤—ñ–Ω–∫–∏, self-destruct
                    </span>
                </div>
            </div>

            <div class="chat-window" id="chat"></div>

            <div class="chat-input-row">
                <div class="chat-input">
                    <input id="msg" class="input" placeholder="–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è‚Ä¶">
                </div>
                <button class="chat-send-btn" onclick="sendMessage()">
                    <span>‚û§</span>
                </button>
            </div>

            <!-- –§–∞–π–ª–∏ (Pro only) -->
            <div class="file-row">
                <input type="file" id="file-input">
                <button class="btn-small btn-secondary" onclick="sendEncryptedFile()">
                    üìÅ Pro-—Ñ–∞–π–ª
                </button>
            </div>

            <!-- –î–∑–≤—ñ–Ω–æ–∫ (Pro only) -->
            <button class="btn btn-secondary" style="margin-top:8px;" onclick="startSecureCall()">
                üìû –ó–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É–≤–∞—Ç–∏ (Pro)
            </button>

            <div class="hint">
                Free: —Ç–µ–∫—Å—Ç–æ–≤–∏–π E2EE-—á–∞—Ç. Pro: + —Ñ–∞–π–ª–∏, –¥–∑–≤—ñ–Ω–∫–∏, —Ç–∞–π–º–µ—Ä —Å–∞–º–æ–∑–Ω–∏—â–µ–Ω–Ω—è.
            </div>
        </div>
    </section>

    <div class="toast" id="toast"></div>
</div>

<script>
    // üîó –ó–ê–ú–Ü–ù–ò –Ω–∞ —Å–≤—ñ–π –±–µ–∫–µ–Ω–¥ –ø—Ä–∏ –ø–æ—Ç—Ä–µ–±—ñ
    const API_BASE = "hhttps://incredible-exploration-production-5a9a.up.railway.app";

    // –°—Ç–∞–Ω
    let currentUserId = null;
    let currentUsername = null;
    let isPro = false;

    let peerID = null;
    let peerUsername = null;

    let lastMessagesCount = 0;
    let pollingInterval = null;

    // –ö—Ä–∏–ø—Ç–æ (–ø–æ–∫–∏ ‚Äì –ø—Ä–æ—Å—Ç–∞ –º–æ–¥–µ–ª—å: –æ–¥–∏–Ω –∫–ª—é—á –Ω–∞ –¥—ñ–∞–ª–æ–≥, —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è AES-GCM)
    const encoder = new TextEncoder();
    const decoder = new TextDecoder();

    const LOCAL_USER_KEY = "spysignal_user";
    const LOCAL_DIALOG_KEYS = "spysignal_dialog_keys_v1";

    const statusDot = document.getElementById("status-dot");
    const statusLabel = document.getElementById("status-label");
    const statusUrl = document.getElementById("status-url");
    const toastEl = document.getElementById("toast");
    const planPill = document.getElementById("plan-pill");
    const planPillFree = document.getElementById("plan-pill-free");
    const premiumCard = document.getElementById("premium-card");
    const proOnlyLabel = document.getElementById("pro-only-label");

    statusUrl.textContent = API_BASE.replace("https://", "");

    function showToast(msg, isError = false) {
        toastEl.textContent = msg;
        toastEl.className = "toast show" + (isError ? " toast-error" : "");
        setTimeout(() => toastEl.classList.remove("show"), 2500);
    }

    function bufToBase64(buf) {
        let bin = "";
        const bytes = new Uint8Array(buf);
        for (let b of bytes) bin += String.fromCharCode(b);
        return btoa(bin);
    }

    function base64ToBuf(b64) {
        const bin = atob(b64);
        const bytes = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
        return bytes.buffer;
    }

    function setPlanUI() {
        if (isPro) {
            planPill.style.display = "inline-flex";
            planPillFree.style.display = "none";
            premiumCard.style.display = "none";
            proOnlyLabel.style.display = "inline-flex";
        } else {
            planPill.style.display = "none";
            planPillFree.style.display = "inline-flex";
            premiumCard.style.display = "block";
            proOnlyLabel.style.display = "none";
        }
    }

    async function checkHealth() {
        try {
            const res = await fetch(`${API_BASE}/health`);
            if (!res.ok) throw new Error("bad status");
            const data = await res.json();
            if (data.status === "ok") {
                statusDot.classList.remove("offline");
                statusLabel.textContent = "–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ —Å–µ—Ä–≤–µ—Ä–∞";
            } else {
                statusDot.classList.add("offline");
                statusLabel.textContent = "–°–µ—Ä–≤–µ—Ä –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–æ";
            }
        } catch {
            statusDot.classList.add("offline");
            statusLabel.textContent = "–ù–µ–º–∞—î –∑–≤'—è–∑–∫—É –∑ –±–µ–∫–µ–Ω–¥–æ–º";
        }
    }

    checkHealth();
    setInterval(checkHealth, 8000);

    (function restoreUser() {
        const raw = localStorage.getItem(LOCAL_USER_KEY);
        if (!raw) return;
        try {
            const parsed = JSON.parse(raw);
            if (parsed.id && parsed.username) {
                currentUserId = parsed.id;
                currentUsername = parsed.username;
                isPro = !!parsed.is_pro;
                document.getElementById("username").value = currentUsername;
                setPlanUI();
                document.getElementById("login-card").style.display = "none";
                document.getElementById("main-blocks").style.display = "flex";
                const hint = document.getElementById("my-id-hint");
                hint.style.display = "block";
                hint.textContent = `–¢–≤—ñ–π ID –∞–≥–µ–Ω—Ç–∞: ${currentUserId}.`;
                fetchAccountStatus();
            }
        } catch (e) {
            console.warn("–ù–µ –≤–¥–∞–ª–æ—Å—å –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ —Å–µ—Å—ñ—é", e);
        }
    })();

    async function fetchAccountStatus() {
        if (!currentUserId) return;
        try {
            const res = await fetch(`${API_BASE}/api/account/${currentUserId}`);
            if (!res.ok) return;
            const data = await res.json();
            isPro = !!data.is_pro;
            const raw = localStorage.getItem(LOCAL_USER_KEY);
            if (raw) {
                const parsed = JSON.parse(raw);
                parsed.is_pro = isPro;
                localStorage.setItem(LOCAL_USER_KEY, JSON.stringify(parsed));
            }
            setPlanUI();
        } catch (e) {
            console.warn("–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –∞–∫–∞—É–Ω—Ç—É", e);
        }
    }

    async function registerUser() {
        const usernameInput = document.getElementById("username");
        const name = usernameInput.value.trim();
        if (!name) {
            showToast("–í–≤–µ–¥–∏ –ø–æ–∑–∏–≤–Ω–∏–π (username)", true);
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/api/users/register`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username: name })
            });
            const data = await res.json();
            if (!res.ok || !data.id) {
                console.error("–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó:", data);
                showToast("–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó", true);
                return;
            }

            currentUserId = data.id;
            currentUsername = data.username;
            isPro = !!data.is_pro;

            localStorage.setItem(LOCAL_USER_KEY, JSON.stringify({
                id: currentUserId,
                username: currentUsername,
                is_pro: isPro
            }));

            document.getElementById("login-card").style.display = "none";
            document.getElementById("main-blocks").style.display = "flex";

            const hint = document.getElementById("my-id-hint");
            hint.style.display = "block";
            hint.textContent = `–¢–≤—ñ–π ID –∞–≥–µ–Ω—Ç–∞: ${currentUserId}. –ü–µ—Ä–µ–¥–∞–π –π–æ–≥–æ —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫—É –¥–ª—è –ø–æ—à—É–∫—É.`;

            setPlanUI();
            showToast("–£—Å–ø—ñ—à–Ω–æ. ID: " + currentUserId);
        } catch (e) {
            console.error(e);
            showToast("–ù–µ –≤–¥–∞–ª–æ—Å—å –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—å –¥–æ —Å–µ—Ä–≤–µ—Ä–∞", true);
        }
    }

    function backToLogin() {
        peerID = null;
        peerUsername = null;
        document.getElementById("main-blocks").style.display = "none";
        document.getElementById("login-card").style.display = "block";
    }

    async function searchUser() {
        const q = document.getElementById("search").value.trim();
        const resultEl = document.getElementById("result");
        if (!q) {
            resultEl.innerHTML = "";
            return;
        }
        try {
            const res = await fetch(`${API_BASE}/api/users/search?query=${encodeURIComponent(q)}`);
            const data = await res.json();
            const users = data.results || [];
            let html = "";
            if (users.length === 0) {
                html = `<div class="hint">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.</div>`;
            } else {
                users.forEach(u => {
                    html += `
                        <div class="user-item" onclick="openChat(${u.id}, '${u.username}')">
                            <div class="user-name">${u.username}</div>
                            <div class="user-id">ID: ${u.id}</div>
                        </div>
                    `;
                });
            }
            resultEl.innerHTML = html;
        } catch (e) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É:", e);
            showToast("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–æ—à—É–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤", true);
        }
    }

    function getDialogKeyId(peerId) {
        return `${currentUserId}-${peerId}`;
    }

    async function getOrCreateDialogKey(peerId) {
        const raw = localStorage.getItem(LOCAL_DIALOG_KEYS);
        let map = raw ? JSON.parse(raw) : {};
        const keyId = getDialogKeyId(peerId);
        if (map[keyId]) {
            const keyBuf = base64ToBuf(map[keyId]);
            return await crypto.subtle.importKey(
                "raw", keyBuf, "AES-GCM", true, ["encrypt", "decrypt"]
            );
        }
        const key = await crypto.subtle.generateKey(
            { name: "AES-GCM", length: 256 },
            true,
            ["encrypt", "decrypt"]
        );
        const rawKey = await crypto.subtle.exportKey("raw", key);
        map[keyId] = bufToBase64(rawKey);
        localStorage.setItem(LOCAL_DIALOG_KEYS, JSON.stringify(map));
        return key;
    }

    async function encryptDialogMessage(peerId, plaintext) {
        const key = await getOrCreateDialogKey(peerId);
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const ctBuf = await crypto.subtle.encrypt(
            { name: "AES-GCM", iv },
            key,
            encoder.encode(plaintext)
        );
        return {
            iv: bufToBase64(iv.buffer),
            ciphertext: bufToBase64(ctBuf)
        };
    }

    async function decryptDialogMessage(peerId, ciphertextB64, ivB64) {
        const key = await getOrCreateDialogKey(peerId);
        const ivBuf = base64ToBuf(ivB64);
        const ctBuf = base64ToBuf(ciphertextB64);
        const plainBuf = await crypto.subtle.decrypt(
            { name: "AES-GCM", iv: new Uint8Array(ivBuf) },
            key,
            ctBuf
        );
        return decoder.decode(plainBuf);
    }

    async function openChat(id, username) {
        peerID = id;
        peerUsername = username;

        const chatPeerEl = document.getElementById("chat-peer");
        chatPeerEl.innerHTML = `3 ¬∑ –ß–∞—Ç –∑ <span>${username}</span> (ID: ${id})`;

        const chatCard = document.getElementById("chat-card");
        chatCard.style.opacity = "1";
        chatCard.style.pointerEvents = "auto";

        lastMessagesCount = 0;
        await loadMessages();

        if (pollingInterval) clearInterval(pollingInterval);
        pollingInterval = setInterval(loadMessages, 2000);
    }

    async function loadMessages() {
        if (!peerID || !currentUserId) return;
        try {
            const res = await fetch(`${API_BASE}/api/messages?peer_id=${peerID}&me=${currentUserId}`);
            const data = await res.json();
            const msgs = data.messages || [];
            const chatEl = document.getElementById("chat");

            const isNew = msgs.length > lastMessagesCount;
            let html = "";

            for (const m of msgs) {
                const cls = (m.from_id === currentUserId) ? "msg me" : "msg";
                let text = "[–Ω–µ –≤–¥–∞–ª–æ—Å—è —Ä–æ–∑—à–∏—Ñ—Ä—É–≤–∞—Ç–∏]";

                try {
                    text = await decryptDialogMessage(peerID, m.ciphertext, m.iv);
                } catch (e) {
                    console.warn("–ü–æ–º–∏–ª–∫–∞ –¥–µ—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è", e);
                }

                const date = new Date(m.created_at);
                const hh = String(date.getHours()).padStart(2, "0");
                const mm = String(date.getMinutes()).padStart(2, "0");

                html += `
                    <div class="${cls}">
                        <div>${text}</div>
                        <div class="msg-meta">${hh}:${mm}</div>
                    </div>
                `;
            }

            chatEl.innerHTML = html;
            chatEl.scrollTop = chatEl.scrollHeight;
            lastMessagesCount = msgs.length;
        } catch (e) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å:", e);
        }
    }

    async function sendMessage() {
        const input = document.getElementById("msg");
        const msg = input.value.trim();
        if (!msg || !peerID || !currentUserId) return;

        try {
            const { iv, ciphertext } = await encryptDialogMessage(peerID, msg);

            await fetch(`${API_BASE}/api/messages`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    from_id: currentUserId,
                    to: peerID,
                    iv,
                    ciphertext
                })
            });

            input.value = "";
            await loadMessages();
        } catch (e) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è:", e);
            showToast("–ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è", true);
        }
    }

    async function sendEncryptedFile() {
        if (!isPro) {
            showToast("–§–∞–π–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ —Ç—ñ–ª—å–∫–∏ –≤ SpySignal PRO", true);
            return;
        }
        const fileInput = document.getElementById("file-input");
        const file = fileInput.files[0];
        if (!file) {
            showToast("–û–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏", true);
            return;
        }
        if (!peerID || !currentUserId) {
            showToast("–û–±–µ—Ä—ñ—Ç—å —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞", true);
            return;
        }

        try {
            const arrayBuf = await file.arrayBuffer();
            const key = await getOrCreateDialogKey(peerID);
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const ctBuf = await crypto.subtle.encrypt(
                { name: "AES-GCM", iv },
                key,
                arrayBuf
            );

            const payload = {
                from_id: currentUserId,
                to: peerID,
                filename: file.name,
                mimetype: file.type || "application/octet-stream",
                iv: bufToBase64(iv.buffer),
                ciphertext: bufToBase64(ctBuf)
            };

            await fetch(`${API_BASE}/api/files/upload`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            showToast("–§–∞–π–ª –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ —Ç–∞ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ (Pro)");
            fileInput.value = "";
        } catch (e) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª—É:", e);
            showToast("–ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ñ–∞–π–ª", true);
        }
    }

    async function startSecureCall() {
        if (!isPro) {
            showToast("–î–∑–≤—ñ–Ω–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ —Ç—ñ–ª—å–∫–∏ –≤ SpySignal PRO", true);
            return;
        }
        showToast("WebRTC –¥–∑–≤—ñ–Ω–∫–∏ –¥–µ–º–æ: —Å–∏–≥–Ω–∞–ª—å–Ω–∏–π –∫–∞–Ω–∞–ª –≥–æ—Ç–æ–≤–∏–π, –ª–æ–≥—ñ–∫—É WebRTC –º–æ–∂–Ω–∞ –¥–æ—Ä–æ–±–∏—Ç–∏", false);
        // –¢—É—Ç —Ç–∏ –ø—ñ–¥–∫–ª—é—á–∏—à —Å–≤—ñ–π WebRTC-–∫–æ–¥ –¥–æ /api/call/offer /answer /candidate
    }

    async function fakeUpgradePro() {
        if (!currentUserId) {
            showToast("–°–ø–æ—á–∞—Ç–∫—É —É–≤—ñ–π–¥–∏ –≤ –∞–∫–∞—É–Ω—Ç", true);
            return;
        }
        try {
            const res = await fetch(`${API_BASE}/api/pro/fake-upgrade`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ user_id: currentUserId })
            });
            const data = await res.json();
            if (!res.ok || !data.ok) {
                showToast("–ü–æ–º–∏–ª–∫–∞ –∞–ø–≥—Ä–µ–π–¥—É", true);
                return;
            }
            isPro = true;
            const raw = localStorage.getItem(LOCAL_USER_KEY);
            if (raw) {
                const parsed = JSON.parse(raw);
                parsed.is_pro = true;
                localStorage.setItem(LOCAL_USER_KEY, JSON.stringify(parsed));
            }
            setPlanUI();
            showToast("SpySignal PRO –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ (–¥–µ–º–æ)");
        } catch (e) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –∞–ø–≥—Ä–µ–π–¥—É:", e);
            showToast("–ù–µ –≤–¥–∞–ª–æ—Å—å –∑–≤'—è–∑–∞—Ç–∏—Å—å –∑ —Å–µ—Ä–≤–µ—Ä–æ–º", true);
        }
    }
</script>
</body>
</html>
